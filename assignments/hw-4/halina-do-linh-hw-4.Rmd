---
title: "EDS241: Assignment 4"
author: "Halina Do-Linh"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: no
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)
# load packages
librarian::shelf(here,
                 tidyr,
                 stringr,
                 janitor,
                 estimatr,
                 cowplot,
                 ggplot2,
                 tinytex,
                 datasets,
                 tibble,
                 tidyverse,
                 huxtable,
                 car,
                 readxl,
                 AER) # AER package has ivreg()

# devtools::install_github('rstudio/rmarkdown')
options(scipen=999) # not scientific notation
```

\noindent For Assignment 4, we will estimate the price elasticity of
demand for fresh sardines across 56 ports located in 4 European
countries with monthly data from 2013 to 2019. The data are contained in
the file `EU_sardines.csv`.

\noindent We are using the following variables: `year`, `month`,
`country`, `port` (port where sardines are landed and sold),
`price_euro_kg` (price per kg in â‚¬), and `volume_sold_kg` (quantity of
sardines sold in kg). In the questions below, I use `log()` to denote
the natural logarithm.

# Load Data & Prepare dataset

```{r}
sardines_data <- read_csv(here::here("assignments/data/EU_sardines.csv"))
```

# Question A

\noindent Estimate a bivariate regression of `log(volume_sold_kg)` on
`log(price euro_kg)`. What is the price elasticity of demand for
sardines? Test the null hypothesis that the price elasticity is equal to
-1.

```{r}
# log of volume sold and price 
sardines_log <- sardines_data %>% 
  mutate(price_euro_kg_log = log(price_euro_kg),
         volume_sold_kg_log = log(volume_sold_kg))

# bivariate regression
model_1 <- lm_robust(data = sardines_log, 
                     volume_sold_kg_log ~ price_euro_kg_log)
huxreg(model_1)

# test that price = -1 ??
#linearHypothesis(model_1, c("price_euro_kg_log=-1"), white.adjust = "hc2")
```

\noindent \textbf{Answer:} Reject the null hypothesis based on the CI's because it does not overlap at -1.

# Question B

\noindent Like in Lecture 8 (see the IV.R script), we will use wind_m\_s
as an instrument for log(price_euro_kg). To begin, estimate the
first-stage regression relating log(price_euro_kg) to `wind_m_s`.
Interpret the estimated coefficient on wind speed. Does it have the
expected sign? Also test for the relevance of the instrument and whether
it is a "weak" instrument by reporting the proper F-statistic.

\begin{align}
  price_euro_kg_log_{i} = \beta_0 + \beta_1 wind_m_s_{1i} + u_{i}
\end{align}

```{r}
# first stage regression
model_2 <- lm_robust(data = sardines_log, price_euro_kg_log ~ wind_m_s)
huxreg(model_2)
```

```{r}
# iv test
tsls1 <- ivreg(price_euro_kg_log ~ wind_m_s | wind_m_s, data = sardines_log)
summary(tsls1)
```

\noindent \textbf{Answer:} The estimated coefficient \beta\_1 on `wind_m_s` tells us that windspeed increases the price in euros by `r round(model_2$coefficients[2], 3)` and this is the right sign?

# Question C

\noindent Estimate the TSLS (two stage least squared) estimator of the
price elasticity of demand for sardines using wind_m\_s as an instrument
for log(price_euro_kg). What is the estimated price elasticity of demand
for sardines?

```{r}
tsls1 <- ivreg(price_euro_kg_log ~ wind_m_s | wind_m_s, data = sardines_log)
summary(tsls1)
```


# Question D

\noindent Repeat the exercise in (c), but include fixed effects for each
year, month, and country. [Hint: you can use the command
"as.factor(country) + as.factor(year) +as.factor(month)" to the ivreg
function in R]. Report the estimated price elasticity of demand and the
F-statistic testing for relevant and non-weak instruments.

```{r}
tsls1_felm <- felm(price_euro_kg_log ~ wind_m_s | wind_m_s, data = sardines_log)
summary(tsls1)

# "log_tots ~ 1" is not the first stage, it is the all variables in the first stage, BUT the endogenous one
# | 0 | means that we are not including fixed effects here.

tsls1_felm <- felm(formula = log_tots ~ 1 | 0 | (log_price ~ windspd),  data=FULTON)
```

