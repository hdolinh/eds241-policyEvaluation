---
title: "EDS241: Assignment 4"
author: "Halina Do-Linh"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: no
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)
# load packages
librarian::shelf(here,
                 tidyr,
                 stringr,
                 janitor,
                 estimatr,
                 cowplot,
                 ggplot2,
                 tinytex,
                 datasets,
                 tibble,
                 tidyverse,
                 huxtable,
                 car,
                 readxl,
                 AER) # AER package has ivreg()

# devtools::install_github('rstudio/rmarkdown')
options(scipen=999) # not scientific notation
```

\noindent For Assignment 4, we will estimate the price elasticity of
demand for fresh sardines across 56 ports located in 4 European
countries with monthly data from 2013 to 2019. The data are contained in
the file `EU_sardines.csv`.

\noindent We are using the following variables: `year`, `month`,
`country`, `port` (port where sardines are landed and sold),
`price_euro_kg` (price per kg in â‚¬), and `volume_sold_kg` (quantity of
sardines sold in kg). In the questions below, I use `log()` to denote
the natural logarithm.

# Load Data

```{r}
sardines_data <- read_csv(here::here("assignments/data/EU_sardines.csv"))
```

# Question A

\noindent Estimate a bivariate regression of `log(volume_sold_kg)` on
`log(price euro_kg)`. What is the price elasticity of demand for
sardines? Test the null hypothesis that the price elasticity is equal to
-1.

## Questions
- Best way to test null hypo? Is CI's enough? 
- double check model

```{r}
# log of volume sold and price 
sardines_log <- sardines_data %>% 
  mutate(price_euro_kg_log = log(price_euro_kg),
         volume_sold_kg_log = log(volume_sold_kg))

# bivariate regression
model_1 <- lm_robust(data = sardines_log, 
                     volume_sold_kg_log ~ price_euro_kg_log)
huxreg(model_1, 
       bold_signif = 0.05,
       ci_level = 0.95,
       error_format = ("({conf.low} -- {conf.high})"))
```

\noindent \textbf{Answer:} We can reject the null hypothesis that price elasticity is equal to -1 because the confidence intervals for `price_euro_kg_log` are within the range `r round(model_1$conf.low[2], 3)` and `r round(model_1$conf.high[2], 3)` at a 95% significance level.

# Question B

\noindent Like in Lecture 8 (see the IV.R script), we will use wind_m\_s
as an instrument for log(price_euro_kg). To begin, estimate the
first-stage regression relating log(price_euro_kg) to `wind_m_s`.
Interpret the estimated coefficient on wind speed. Does it have the
expected sign? Also test for the relevance of the instrument and whether
it is a "weak" instrument by reporting the proper F-statistic.

\begin{align}
  price_euro_kg_log_{i} = \beta_0 + \beta_1 wind_m_s_{1i} + u_{i}
\end{align}

## Questions
- How to know what is the expected sign? You catch less when it's bad conditions aka windy so we expect the sign to be positive therefore more expensive price for sardines when wind increases

```{r}
# first stage regression
model_2 <- lm_robust(data = sardines_log, price_euro_kg_log ~ wind_m_s)
huxreg(model_2)
```

\noindent \textbf{Answer:} The estimated coefficient \beta\_1 on `wind_m_s` tells us that for each 1 $m/s$ wind speed the price of sardines in euros increases by `r round(model_2$coefficients[2], 3)`. I believe this is the expected sign because....


```{r}
# instrument relevance and non--weak test 
# want f-statistic to be greater than 10
hypo_1 <- linearHypothesis(model_2, # first stage regression model
                 c("wind_m_s = 0"), # null hypothesis
                 white.adjust = "hc2") # robust heteroskedastic errors
```

\noindent \textbf{Answer:} The F-statistic is `r round(hypo_1$Chisq[2], 2)` and is greater than 10 and is therefore not a weak instrument.

# Question C

\noindent Estimate the TSLS (two stage least squared) estimator of the
price elasticity of demand for sardines using `wind_m_s` as an instrument
for log(price_euro_kg). What is the estimated price elasticity of demand
for sardines?

```{r}
tsls1 <- ivreg(volume_sold_kg_log ~ price_euro_kg_log | wind_m_s, data = sardines_log)
huxreg(tsls1)
```

\noindent \textbf{Answer:} The estimated price elasticity of demand for sardines is `r  round(tsls1$coefficients[2], 2)`. 

# Question D

\noindent Repeat the exercise in (c), but include fixed effects for each
year, month, and country. [Hint: you can use the command
"as.factor(country) + as.factor(year) +as.factor(month)" to the ivreg
function in R]. Report the estimated price elasticity of demand and the
F-statistic testing for relevant and non-weak instruments.

## Question
- What is the correct model? Where to put the fixed effects?
- What is over identified model mean? I.e. from IV.R lab
- Do we need a different model for getting the F-statistic? 

```{r}
# tsls with fixed effects
tsls_fixed <- ivreg(volume_sold_kg_log ~ price_euro_kg_log + as.factor(country) + as.factor(year) + as.factor(month)
                    | as.factor(country) + as.factor(year) + as.factor(month) + wind_m_s, data = sardines_log)
```


```{r}
# instrument relevance and non--weak test 
# want f-statistic to be greater than 10
hypo_2 <- linearHypothesis(tsls_fixed, 
                 c("wind_m_s=0"), 
                 white.adjust = "hc2")

## get an error here....which model should I use?
```

\noindent \textbf{Answer:} The estimated price elasticity of demand is `r round(tsls_fixed$coefficients[2], 2)`. And the F-staistic testing for relevant and non-weak instruments is `r `.
